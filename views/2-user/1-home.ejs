<%- include('../partials/header.ejs') %>
<!-- Toast Notification Structure -->
<div id="toast" class="fixed left-1/2 bottom-[-100px] transform -translate-x-1/2 min-w-[200px] bg-red-500 text-white text-center text-sm rounded-md px-4 py-3 z-[9999] transition-all duration-500 ease-in-out opacity-0 invisible">
    <!-- Message set by JS -->
</div>

<body class="overflow-x-hidden"> <!-- Prevent horizontal scroll -->
    <div class="page-container flex flex-col min-h-screen bg-gray-100"> <!-- Added base background -->
        <!-- Include nav and menu OUTSIDE the main content wrapper -->
        <%- include('../partials/nav.ejs') %>
        <%- include('../partials/menu.ejs', { headerTitle: "HOME" }) %> <!-- Pass a title if needed -->

        <!-- Main Content Area Wrapper - Takes remaining space and applies padding -->
        <div class="content-wrap flex-1 pt-5 pl-16 pr-4 lg:pl-[14vw]">
            <!-- Inner container for max-width and centering, matching menu's inner container -->
            <div class="max-w-6xl 2xl:max-w-screen-xl mx-auto">

                <!-------------------- CONTENTS START -------------------->
                <!-- Use Grid layout for large screens -->
                <div class="lg:grid lg:grid-cols-[minmax(0,1fr)_23vw] lg:gap-4">

                    <!-- Left Column (Form/Filters/Posts) -->
                    <div class="flex flex-col gap-4">
                        <!-- Post Form (Admin/Staff Only) -->
                        <% if (user && (user.roles.includes('Admin') || user.roles.includes('Staff'))) { %>
                            <div class="post-container relative bg-white p-5 rounded-[20px] shadow-md flex flex-col"> <%# Removed h-full, height determined by content %>
                                <form id="post-form" enctype="multipart/form-data">
                                    <input type="text" id="post-title" name="title" placeholder="Enter post title..." required
                                           class="w-full h-10 lg:h-[2.5vw] /* Adjusted height */ p-2.5 text-base border-none rounded-lg outline-none bg-gray-100 text-gray-800 mb-2 focus:ring-1 focus:ring-green-500">
                                    <textarea name="text" class="post-textbox w-full h-[80px] p-3 text-base border-none rounded-lg outline-none bg-gray-100 text-gray-800 resize-none mb-2 focus:ring-1 focus:ring-green-500" placeholder="Write something..." required></textarea>

                                    <input type="file" id="image-input" name="media" accept="image/*" multiple class="hidden">
                                    <input type="file" id="video-input" name="video" accept="video/*" class="hidden">

                                    <div id="preview-container" class="flex flex-wrap gap-2.5 mt-2.5">
                                        <!-- Previews added by JS -->
                                    </div>

                                    <div class="post-options flex items-center gap-2.5 mt-2.5">
                                        <button type="button" class="post-option-button bg-none border-none cursor-pointer p-1.5" id="add-image-button">
                                            <img src="/img/image.png" alt="Add Image" class="option-icon w-5 h-5">
                                        </button>
                                        <button type="button" class="post-option-button bg-none border-none cursor-pointer p-1.5" id="add-video-button">
                                            <img src="/img/video.png" alt="Add Video" class="option-icon w-5 h-5">
                                        </button>
                                         <!-- Position post button absolutely within the container -->
                                         <button type="submit" class="post-button absolute bottom-5 right-6 bg-[#00722A] text-white text-[15px] font-bold py-2 px-5 border-none rounded-[10px] cursor-pointer transition hover:bg-[#00591F]">Post</button>
                                    </div>
                                </form>
                            </div>
                        <% } %>

                        <!-- Post Filters -->
                        <%# Added lg:flex-nowrap to prevent wrapping on large screens %>
                        <div class="post-filters bg-white py-4 px-5 rounded-[15px] shadow-md flex flex-wrap lg:flex-nowrap gap-2.5 items-center font-sans w-full">
                            <%# Changed lg:w-[calc(...)] to lg:flex-1 to allow search input to grow %>
                            <input type="text" id="searchInput" placeholder="Search posts..."
                                           class="flex-grow lg:flex-1 p-2.5 rounded-[10px] border border-gray-300 bg-gray-100 text-sm text-gray-800 outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 placeholder-gray-500 min-w-0"> <%# Added min-w-0 for flex sizing %>
                            <select id="filterMonth" class="p-2.5 rounded-[10px] border border-gray-300 bg-gray-100 text-sm text-gray-800 outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 flex-shrink-0"> <%# Added flex-shrink-0 %>
                                <option value="">Month</option>
                                <% for (let m = 0; m < 12; m++) { %>
                                    <option value="<%= m %>"><%= new Date(2000, m).toLocaleString('default', { month: 'long' }) %></option>
                                <% } %>
                            </select>
                            <select id="filterYear" class="p-2.5 rounded-[10px] border border-gray-300 bg-gray-100 text-sm text-gray-800 outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500 flex-shrink-0"> <%# Added flex-shrink-0 %>
                                <option value="">Year</option>
                                <% const currentYear = new Date().getFullYear(); for (let y = currentYear; y >= currentYear - 10; y--) { %>
                                    <option value="<%= y %>"><%= y %></option>
                                <% } %>
                            </select>
                            <button id="filterBtn" class="bg-[#00722A] text-white py-2.5 px-4 text-sm font-bold border-none rounded-[10px] cursor-pointer transition hover:bg-[#00591F] flex-shrink-0">Filter</button> <%# Added flex-shrink-0 %>
                        </div>

                        <!-- Posts Container -->
                        <div id="posts-container" class="w-full">
                            <%# Pass pagination data if available from the initial load, default to 1 if not %>
                            <%- include('../partials/postList.ejs', {
                                posts: posts,
                                user: user,
                                currentPage: (typeof currentPage !== 'undefined' ? currentPage : 1),
                                totalPages: (typeof totalPages !== 'undefined' ? totalPages : 1)
                            }) %>
                        </div>

                        <!-- Pagination Controls Container -->
                        <div id="pagination-controls" class="flex justify-center items-center space-x-2 mt-6 mb-6">
                            <!-- Pagination buttons will be dynamically added here by home.js -->
                        </div>
                    </div> <!-- End Left Column -->

                    <!-- Right Column (Live/Schedule) -->
                    <div class="flex flex-col gap-4 mt-4 lg:mt-0"> <%# Add margin top for mobile stacking, remove for grid layout %>
                        <!-- Live Now! -->
                        <div class="live-now-container relative bg-white p-4 rounded-[15px] shadow-md w-full">
                            <% if (user && (user.roles.includes('Admin') || user.roles.includes('Staff'))) { %>
                                <button onclick="openStatusModal()" class="status-btn absolute top-2 right-2 bg-gray-700 text-white border-none py-1 px-2.5 rounded-md cursor-pointer text-xs z-10">Status</button>
                            <% } %>
                            <div id="live-now-content" class="text-center">
                                <span id="status-indicator" class="status-offline text-gray-800 text-base font-extrabold inline-block">OFFLINE</span>
                                <p id="live-now-subtext" class="text-sm text-gray-500 mb-2">No live broadcast available.</p>
                            </div>
                            <a id="live-now-link" href="/live" class="go-live-button hidden mx-auto mt-2 py-2 px-4 bg-[#00722A] text-white rounded-[10px] no-underline font-bold text-center text-sm hover:bg-[#00591F]">GO TO LIVE</a>
                        </div>

                        <!-- Schedule -->
                        <div class="schedule-container bg-white p-4 rounded-[15px] shadow-md w-full">
                            <div class="schedule-header flex justify-between items-center mb-2">
                                <h3 class="m-0 text-lg font-semibold text-green-700">Today's Schedule</h3>
                            </div>
                            <ul id="schedule-list" class="list-disc pl-5 space-y-1 text-sm text-gray-700">
                                <li>Loading schedule...</li>
                            </ul>
                        </div>
                    </div> <!-- End Right Column -->

                </div> <!-- End Grid Container -->
                <!-------------------- CONTENTS END -------------------->

                <!-- Media Modal (Full Screen Overlay) -->
                <div id="media-modal" class="media-modal hidden fixed inset-0 z-[9999] bg-black/80 justify-center items-center"> <!-- Starts hidden, uses flex for centering -->
                    <span class="close-modal absolute top-2 right-5 text-4xl text-white cursor-pointer z-10">×</span>
                    <div class="modal-content relative max-w-[90%] max-h-[90%] flex items-center justify-center w-auto h-auto"> <!-- Adjusted for centering content -->
                        <button class="nav-arrow left-arrow absolute top-1/2 transform -translate-y-1/2 left-[-3vw] lg:left-[-50px] bg-none border-none text-4xl text-white cursor-pointer p-2.5 z-10">❮</button>
                        <!-- Media elements: JS will show one at a time -->
                        <img id="modal-image" class="modal-media block max-w-full max-h-full w-auto h-auto object-contain rounded-lg" style="display: none;">
                        <video id="modal-video" class="modal-media block max-w-full max-h-full w-auto h-auto object-contain rounded-lg" controls style="display: none;"></video>
                        <button class="nav-arrow right-arrow absolute top-1/2 transform -translate-y-1/2 right-[-3vw] lg:right-[-50px] bg-none border-none text-4xl text-white cursor-pointer p-2.5 z-10">❯</button>
                    </div>
                </div>

                <!-- Status Modal -->
                <div id="status-modal" class="modal-overlay hidden fixed inset-0 z-[9999] bg-black/80 justify-center items-center"> <!-- Starts hidden, uses flex -->
                    <div class="modal-content bg-white rounded-[15px] w-[90%] max-w-xs lg:max-w-[20vw] h-auto flex flex-col p-5 gap-4 relative"> <!-- Adjusted width, padding -->
                         <h3 class="text-lg font-semibold text-center text-gray-800 mb-0">Set Live Status</h3>
                         <button onclick="closeStatusModal()" class="modal-close absolute top-2 right-3 bg-transparent border-none text-gray-500 font-bold text-xl cursor-pointer">×</button>
                         <div class="modal-buttons flex flex-col sm:flex-row justify-between gap-2 mt-2">
                             <button onclick="setStatus(true)" class="modal-button live flex-1 py-2.5 px-2.5 font-bold border-none rounded-md cursor-pointer text-center bg-[#00722A] text-white hover:bg-[#00591F]">Set Live</button>
                             <button onclick="setStatus(false)" class="modal-button offline flex-1 py-2.5 px-2.5 font-bold border-none rounded-md cursor-pointer text-center bg-gray-600 text-white hover:bg-gray-700">Set Offline</button> <!-- Different color for Offline -->
                         </div>
                    </div>
                </div>

            </div> <!-- End max-w / mx-auto container -->
        </div> <!-- End content-wrap -->

        <%- include('../partials/footer.ejs') %>

        <script src="/js/2-user/home.js"></script> <!-- Ensure path is correct -->

    </div> <!-- End page-container -->
</body>
</html>