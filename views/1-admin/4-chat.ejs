<%- include('../partials/header.ejs') %>
<!-- Set user ID on body for JS access -->
<body data-user-id="<%= user._id %>" class="overflow-hidden bg-gray-100"> <!-- Added overflow-hidden and bg-gray-100 -->

    <div class="page-container flex flex-col min-h-screen">
        <%- include('../partials/nav.ejs') %> <!-- Moved nav outside -->
        <%- include('../partials/menu.ejs') %> <!-- Moved menu outside -->

        <!-- Padded wrapper for main content, sibling to nav/menu -->
        <div class="content-wrap flex-1 pt-5 pl-16 pr-4 lg:pl-[14vw]">

            <!-------------------- CONTENTS START -------------------->
             <!-- Max-width wrapper for content alignment -->
             <div class="max-w-6xl 2xl:max-w-screen-xl mx-auto">

                 <!-- Toggle Button for Small Screens -->
                 <button id="sidebar-toggle" class="md:hidden bg-green-700 text-white py-2 px-4 rounded-md mb-3 font-semibold">
                     Toggle Inbox
                 </button>

                 <!-- Styles from .chat-wrapper - Removed px-[4vw], Added mt-2 -->
                <div class="chat-wrapper flex flex-col md:flex-row gap-5 mt-2 md:mt-0"> <!-- Removed mt-2 on md+ -->

                    <!-- Sidebar -->
                    <!-- Added ID, initially hidden on small screens, flex on md+ -->
                     <div id="chat-sidebar-container" class="chat-sidebar flex-shrink-0 md:flex-basis-1/4 bg-white p-4 rounded-[15px] shadow-lg h-[75vh] flex flex-col space-y-3 hidden md:flex">
                        <%# Button Group %>
                        <div class="flex space-x-2">
                            <button id="open-new-chat" type="button" class="flex-1 bg-green-700 text-white border-none py-2 px-4 rounded-full font-bold cursor-pointer text-[0.95rem] hover:bg-green-900 transition duration-200 ease-in-out">New Chat</button>
                            <%# Changed flex-1 to flex-none, added width/height, padding, and SVG icon %>
                            <button id="open-archived-chats" type="button" title="Archived Chats" class="flex-none w-10 h-10 p-2 bg-gray-500 text-white border-none rounded-full font-bold cursor-pointer text-[0.95rem] hover:bg-gray-700 transition duration-200 ease-in-out flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
                                </svg>
                            </button>
                        </div>
                        <h2 class="mt-4 text-2xl text-green-700 font-semibold border-t pt-3">Inbox</h2>
                        <!-- Added overflow-y-auto and scrollbar-hide to this div -->
                        <div class="flex-grow space-y-2 overflow-y-auto scrollbar-hide"> <!-- Wrapper for chat rooms is now scrollable -->
                            <% chats.forEach(chat => { %>
                                <%# Check if the chat is NOT archived by the current user %>
                                <% if (!chat.archivedBy || !chat.archivedBy.some(id => id.equals(user._id))) { %>
                                    <!-- Add data-creator-id attribute -->
                                    <div class="chat-room relative bg-white p-2.5 mt-2 rounded-lg cursor-pointer transition duration-200 ease-in-out hover:bg-green-700 hover:text-white group"
                                         data-id="<%= chat._id %>"
                                         data-creator-id="<%= chat.creator ? chat.creator._id.toString() : '' %>"
                                         data-latest-message-timestamp="<%= chat.updatedAt.toISOString() %>"> <!-- Added creator ID -->
                                        <% if (chat.isGroupChat) { %>
                                            <!-- Added group-[.bg-green-800]:text-gray-200 -->
                                            <strong class="text-green-700 group-hover:text-white group-[.bg-green-800]:text-gray-200">[Group]</strong> <%= chat.groupName %>
                                        <% } else { %>
                                            <% const otherUser = chat.users.find(u => u._id.toString() !== user._id.toString()); %>
                                            <% if (otherUser) { %>
                                                <%= otherUser.username %>
                                                <!-- Added group-[.bg-green-800]:text-gray-200 -->
                                                <span class="text-xs text-gray-500 group-hover:text-gray-200 group-[.bg-green-800]:text-gray-200 ml-1">(<%= otherUser.roles %>)</span>
                                             <% } else { %>
                                                 Chat with Unknown User
                                             <% } %>
                                        <% } %>

                                        <!-- ADD THIS SPAN FOR THE UNREAD DOT -->
                                        <span class="unread-dot w-2.5 h-2.5 bg-blue-500 rounded-full absolute top-2 right-2 hidden"></span>
                                        <!-- END ADDED SPAN -->
                                    </div>
                                <% } %>
                            <% }) %>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <!-- Adjusted width/flex properties -->
                    <div class="chat-area w-full md:flex-1 flex flex-col bg-white rounded-[15px] shadow-lg h-[75vh] overflow-hidden p-4">
                        <!-- Chat Header -->
                        <!-- Added relative positioning and flex for alignment -->
                        <div id="chat-header" class="relative flex justify-between items-center pb-3 border-b border-gray-300 mb-3">
                            <h2 id="chat-name" class="text-lg font-semibold text-gray-700 truncate">Select a chat</h2>
                            <!-- Gear Icon and Dropdown -->
                            <div class="relative">
                                <!-- Gear Button (Initially hidden, shown when a chat is active) -->
                                <button id="chat-options-btn" class="hidden text-gray-500 hover:text-gray-700 focus:outline-none p-1 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L7.86 5.85A7.96 7.96 0 005.85 7.86L3.17 8.51c-1.56.38-1.56 2.6 0 2.98l2.68.65A7.96 7.96 0 007.86 14.15l.65 2.68c.38 1.56 2.6 1.56 2.98 0l.65-2.68a7.96 7.96 0 002.01-2.01l2.68-.65c1.56-.38 1.56-2.6 0-2.98l-2.68-.65A7.96 7.96 0 0012.14 5.85l-.65-2.68zm-1.49 6.33a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" clip-rule="evenodd" />
                                        <path d="M10 3a1 1 0 011 1v.01a1 1 0 11-2 0V4a1 1 0 011-1zm0 14a1 1 0 01-1-1v-.01a1 1 0 112 0V16a1 1 0 01-1 1zm8-8a1 1 0 01-1 1h-.01a1 1 0 110-2H17a1 1 0 011 1zm-14 0a1 1 0 011-1h.01a1 1 0 110 2H4a1 1 0 01-1-1z" />
                                    </svg>
                                </button>
                                <!-- Dropdown Menu (Initially hidden) -->
                                <div id="chat-options-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                                    <button id="rename-chat-btn" class="hidden w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Rename Chat</button>
                                    <%# Renamed button and updated ID %>
                                    <button id="archive-chat-btn" class="hidden w-full text-left px-4 py-2 text-sm text-orange-600 hover:bg-orange-50">Archive Chat</button>
                                </div>
                            </div>
                        </div>
                        <!-- Messages Container -->
                        <div id="messages" class="flex-1 overflow-y-auto flex flex-col p-4 bg-white rounded-lg mb-4 scrollbar-hide space-y-3">
                            <!-- Messages will be loaded here by chat.js -->
                             <!-- Example structure (handled by JS renderMessage): -->
                             <!-- <div class="message flex flex-col mb-2.5 items-end"> -->
                             <!--   <div class="bubble p-2.5 px-3.5 rounded-2xl max-w-[70%] break-words shadow-sm text-[0.95rem] bg-gray-100 text-gray-800"> -->
                             <!--     <strong>Username</strong><p class="mt-1 mb-0">Message content...</p> -->
                             <!--   </div> -->
                             <!-- </div> -->
                             <!-- <div class="message flex flex-col mb-2.5 items-start"> -->
                             <!--   <div class="bubble p-2.5 px-3.5 rounded-2xl max-w-[70%] break-words shadow-sm text-[0.95rem] bg-green-700 text-white"> -->
                             <!--     <strong>Other Username</strong><p class="mt-1 mb-0">Other message...</p> -->
                             <!--   </div> -->
                             <!-- </div> -->
                         </div>
                        <!-- Message Input Form -->
                        <!-- Changed items-center to items-end -->
                        <form id="message-form" class="flex pt-3 border-t border-gray-300 items-end">
                            <!-- Changed input to textarea, added classes for styling and behavior -->
                            <textarea id="message-input"
                                      placeholder="Type your message..."
                                      rows="1"
                                      class="flex-1 py-2.5 px-3.5 text-base rounded-2xl border border-gray-300 mr-1.5 sm:mr-2.5 focus:outline-none focus:ring-1 focus:ring-green-500 min-w-0 resize-none overflow-y-hidden max-h-24"
                                      style="height: 44px;" ></textarea> <!-- Initial height matching button, resize-none, overflow-hidden -->
                            <!-- Added flex-shrink-0 -->
                            <button type="submit" class="py-2.5 px-4 sm:px-5 bg-green-800 text-white border-none rounded-full font-semibold cursor-pointer hover:bg-green-900 transition duration-200 ease-in-out flex-shrink-0 h-[44px]">Send</button> <!-- Fixed height to match initial textarea height -->
                        </form>
                    </div>
                </div>

                <!-- Start New Chat Modal -->
                <!-- Styles from #modal-backdrop, #new-chat-modal, h3, form elements, #user-list, .user-checkbox -->
                <!-- Modal Backdrop -->
                <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-40 z-[999] hidden"></div>
                <!-- Modal Window -->
                 <div id="new-chat-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-[20px] p-5 shadow-xl z-[1000] w-[90vw] max-w-[400px] hidden flex-col">
                    <h3 class="mt-0 text-green-700 text-center mb-5 text-xl font-semibold">Start New Chat</h3>
                    <form id="new-chat-form" class="flex flex-col">
                        <input type="text" id="group-name" placeholder="Group Name (optional)" class="w-full mb-3 p-2.5 rounded-lg border border-gray-300 box-border text-sm focus:outline-none focus:ring-1 focus:ring-green-500"/>
                        <input type="search" id="user-search" placeholder="Search users..." class="w-full mb-3 p-2.5 rounded-lg border border-gray-300 box-border text-sm focus:outline-none focus:ring-1 focus:ring-green-500"/>

                        <!-- User List Container -->
                         <div id="user-list" class="max-h-[200px] overflow-y-auto mb-4 border border-gray-200 rounded-lg p-2 space-y-2">
                            <% users.forEach(u => { %>
                                <!-- Styles from .user-checkbox -->
                                <div class="user-checkbox">
                                    <label class="flex items-center text-sm cursor-pointer">
                                        <input type="checkbox" name="userIds" value="<%= u._id %>" class="mr-2 h-4 w-4 text-green-700 focus:ring-green-500 border-gray-300 rounded">
                                        <span class="text-gray-700"><%= u.username %> (<%= u.roles %>)</span>
                                    </label>
                                </div>
                            <% }) %>
                        </div>

                        <!-- Modal Buttons -->
                        <button type="submit" class="w-full mb-3 p-2.5 rounded-lg border-none box-border bg-green-700 text-white font-bold transition duration-200 ease-in-out hover:bg-green-900 text-sm">Start Chat</button>
                        <button type="button" id="close-modal" class="w-full p-2.5 rounded-lg border-none box-border bg-gray-500 text-white font-bold transition duration-200 ease-in-out hover:bg-gray-700 text-sm">Cancel</button>
                    </form>
                </div>

                <!-- Archived Chats Modal -->
                <div id="archived-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-40 z-[999] hidden"></div>
                <div id="archived-chats-modal" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-[20px] p-5 shadow-xl z-[1000] w-[90vw] max-w-[500px] hidden flex-col">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="mt-0 text-green-700 text-xl font-semibold">Archived Chats</h3>
                        <button type="button" id="close-archived-modal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
                    </div>
                    <!-- Archived Chat List Container -->
                    <div id="archived-chat-list" class="max-h-[60vh] overflow-y-auto space-y-2">
                        <!-- Archived chats will be loaded here by JS -->
                        <p class="text-center text-gray-500 py-4">Loading archived chats...</p>
                    </div>
                </div>
                <!-- End Archived Chats Modal -->

             </div> <!-- End max-width wrapper -->
             <!-------------------- CONTENTS END -------------------->

        </div> <!-- End content-wrap (padded wrapper) -->

        <%- include('../partials/footer.ejs') %>
        <%- include('../partials/spinner.ejs') %> <!-- Include spinner -->

    </div> <!-- End page-container -->

    <!-- Ensure Socket.IO client is loaded -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Link the updated chat.js -->
    <script src="/js/1-admin/chat.js"></script>
</body>
</html>